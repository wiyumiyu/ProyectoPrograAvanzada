@model ProyectoPrograAvanzada.Models.TAlquilere

@{
    ViewData["Title"] = "Editar Alquiler";
}

<h1 class="mb-4">Editar Alquiler</h1>

<form asp-action="Edit" method="post">
    <input type="hidden" asp-for="IdAlquiler" />

    <!-- ============================= -->
    <!-- ENCABEZADO DEL ALQUILER -->
    <!-- ============================= -->
    <div class="row mb-4">
        <div class="col-md-4">
            <label class="form-label fw-bold">Cliente</label>
            <select asp-for="IdCliente" class="form-control" asp-items="ViewBag.Clientes"></select>
        </div>

        <div class="col-md-4">
            <label class="form-label fw-bold">Sucursal</label>
            <select asp-for="IdSucursal" class="form-control" asp-items="ViewBag.Sucursales"></select>
        </div>

        <div class="col-md-4">
            <label class="form-label fw-bold">Empleado</label>
            <select asp-for="IdEmpleado" class="form-control" asp-items="ViewBag.Empleados"></select>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-4">
            <label class="form-label fw-bold">Impuesto (%)</label>
            <input asp-for="Iva" class="form-control" />
        </div>

        <div class="col-md-4">
            <label class="form-label fw-bold">Estado</label>
            <select asp-for="Estado" class="form-control">
                <option value="Activo">Activo</option>
                <option value="Finalizado">Finalizado</option>
                <option value="Cancelado">Cancelado</option>
            </select>
        </div>
    </div>


    <!-- ============================= -->
    <!-- DETALLES EXISTENTES -->
    <!-- ============================= -->
    <h4 class="fw-bold mt-4">Vehículos Alquilados</h4>

    <table class="table table-striped align-middle text-center">
        <thead class="table-dark">
            <tr>
                <th>Vehículo</th>
                <th>Placa</th>
                <th>Marca</th>
                <th>Tarifa por día</th>
                <th>Fecha inicio</th>
                <th>Fecha fin</th>
                <th>Subtotal</th>
                <th></th>
            </tr>
        </thead>

        <tbody>
            @foreach (var d in Model.TAlquileresDetalles)
            {
                <tr>
                    <td>@d.IdVehiculo</td>
                    <td>@d.IdVehiculoNavigation.Placa</td>
                    <td>@d.IdVehiculoNavigation.Marca</td>
                    <td>₡@d.TarifaDiaria</td>
                    <td>@d.FechaInicio.ToString("dd/MM/yyyy")</td>
                    <td>@d.FechaFin.ToString("dd/MM/yyyy")</td>
                    <td class="fw-bold">₡@d.Subtotal.ToString("N2")</td>

                    <td>
                        <a class="btn btn-sm btn-danger"
                           asp-action="DeleteDetalle"
                           asp-route-id="@d.IdDetalle"
                           asp-route-idAlquiler="@Model.IdAlquiler">
                            Eliminar
                        </a>
                    </td>
                </tr>
            }
        </tbody>
    </table>


    <p class="text-muted mb-4">
        * Si elimina un vehículo, volverá al modo Disponible automáticamente.
    </p>



    <!-- ============================= -->
    <!-- AGREGAR NUEVOS VEHÍCULOS -->
    <!-- ============================= -->
    <h4 class="fw-bold mt-4">Agregar Nuevo Vehículo</h4>

    <button type="button" class="btn btn-success mb-3" onclick="agregarFila()">
        + Agregar Vehículo
    </button>

    <table class="table table-bordered text-center" id="tablaNuevos">
        <thead class="table-light">
            <tr>
                <th>Vehículo</th>
                <th>Tarifa</th>
                <th>Fecha inicio</th>
                <th>Fecha fin</th>
                <th></th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>


    <!-- ============================= -->
    <!-- ACCIONES -->
    <!-- ============================= -->
    <div class="mt-4">
        <button type="submit" class="btn btn-primary">Guardar Cambios</button>
        <a asp-action="Index" class="btn btn-secondary ms-2">Volver</a>
    </div>

</form>



<!-- ============================= -->
<!-- JAVASCRIPT PARA AGREGAR FILAS -->
<!-- ============================= -->
<script>
    var VehiculosDisponibles = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(ViewBag.VehiculosDisponibles));

    function agregarFila() {
        let index = document.querySelectorAll("#tablaNuevos tbody tr").length;

        let options = VehiculosDisponibles.map(v =>
            `<option value="${v.idVehiculo}" data-tarifa="${v.tarifa}">
                ${v.placa} - ${v.marca}
            </option>`
        ).join("");

        let row = `
        <tr>
            <td>
                <select name="nuevos[${index}].IdVehiculo" class="form-select vehiculoSelect">
                    <option value="">Seleccione</option>
                    ${options}
                </select>
            </td>

            <td>
                <input type="number" name="nuevos[${index}].TarifaDiaria" class="form-control tarifa" readonly />
            </td>

            <td>
                <input type="date" name="nuevos[${index}].FechaInicio" class="form-control" />
            </td>

            <td>
                <input type="date" name="nuevos[${index}].FechaFin" class="form-control" />
            </td>

            <td>
                <button type="button" class="btn btn-danger btn-sm" onclick="this.closest('tr').remove()">X</button>
            </td>
        </tr>`;

        document.querySelector("#tablaNuevos tbody")
            .insertAdjacentHTML("beforeend", row);
    }

    document.addEventListener("change", function (e) {
        if (e.target.classList.contains("vehiculoSelect")) {
            let tarifa = e.target.selectedOptions[0].dataset.tarifa;
            let fila = e.target.closest("tr");
            fila.querySelector(".tarifa").value = tarifa;
        }
    });
</script>
